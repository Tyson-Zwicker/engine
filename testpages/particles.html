<html>

<head>
    <script src=".././maths.js"></script>
    <script src=".././gfx.js"></script>
    <script src=".././main.js"></script>
    <script src=".././tattle.js"></script>
</head>

<body onload="buildPage(5)" style="border:none">
    <script>
        const Particle = function (position, velocity, lifespan, rgb) {
            this.position = position;
            this.velocity = velocity;
            this.lifespan = lifespan;
            this.originalLifespan = lifespan;
            this.red = rgb.r;
            this.green = rgb.g;
            this.blue = rgb.b;
            this.manager = null;
        }
        Particle.prototype.move = function (delta) {
            let vp = this.velocity.toPoint();            
            let vx = vp.x * delta;
            let vy = vp.y * delta;
            this.position.x += vx;
            this.position.y += vy;
            this.lifespan -= (delta*1000);

            console.log(`move-delvel ${vx},${vy}`);            
        }
        Particle.prototype.draw = function (camera) {
            let x = this.position.x - camera.x + centerOfScreen.x;
            let y = this.position.y - camera.y + centerOfScreen.y;
            let lifePercent = this.lifespan / this.originalLifespan;
            let r = this.red * lifePercent;
            let g = this.green * lifePercent;
            let b = this.blue * lifePercent;
            let hexColor = rgbToHex(r, g, b);
            drawPixel(x, y, hexColor);
        }
        const ParticleManager = function () {
            this.particles = [];
        }
        
        ParticleManager.prototype.addBurst = function (position, quantity, rgb, lifeMinMax, arc, magnitude) {
            for (let i = 0; i < quantity; i++) {
                let a = rnd(arc.start, arc.end);
                let l = magnitude/2 + rnd (0,magnitude/2);    
                let velocity = new Vector(a, l,);                
                let particle = new Particle(position, velocity, rnd(lifeMinMax.min, lifeMinMax.max), rgb);
                this.particles.push(particle);
                let hexColor = rgbToHex(particle.red, particle.green, particle.blue);
            }
        }
        ParticleManager.prototype.manage = function (camera, delta) {
            let alive = [];
            this.particles.forEach(particle => {
                particle.draw(camera);
                particle.move(delta);
                if (particle.lifespan > 0) {
                    alive.push(particle);
                }
            });
            this.particles = alive;
        }
        let manager = new ParticleManager();
        let camera = { "x": 0, "y": 0 };
        let count = 0;
        manager.addBurst(
            manager.addBurst(
                        new Point(0,0),        //Origin of "spray"
                        rnd(5,55),              //Quanity of partles to generate  
                        { r: 5+rnd (10), g: 5+rnd(1), b: 5+rnd (10) },//Initial Color
                        { min: 2000, max: 10000 },   //Lifespan range
                        { start: 0, end: TAU },   //direction of "spray"\\
                        1+Math.random (5)
                    )
                );
        const program = {
            run: function (delta) {
                //if (count<12) {
                    
                    manager.manage(camera, delta);
                    count++;
                   //if (count%10==0){
                        manager.addBurst(
                        new Point(0,0),        //Origin of "spray"
                        rnd (5,10),              //Quanity of partles to generate  
                        { r: 5+rnd (1,10), g: 5+rnd(1,10), b: 5+rnd (1,10) },//Initial Color
                        { min: 2000, max: 5000 },   //Lifespan range
                        { start: 0, end: TAU },   //direction of "spray"\\
                        15+Math.random (45));
                    //}
                //}
            }
        }
    </script>
</body>

</html>